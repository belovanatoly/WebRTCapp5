<html>
<html>
<head>
<meta charset="utf-8">
<title>user</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    video { height: 240px; width: 320px; border: 1px solid grey; }
	  #debug {font-size: 12px;}
  </style>
   
</head>

<body>


<p>User</p>

  <button id="btn_getUserMedia" onclick="getUserMedia_click()">getUserMedia</button>
  <button id="btn_newPeerConnection" onclick="newPeerConnection_click()">newPeerConnection</button>
  <button id="btn_createOffer" onclick="createOffer_click()">createOffer</button>
  <button id="btn_AudioOn" onclick="AudioOn_click()">AudioOn</button>
  <button id="btn_AudioOff" onclick="AudioOff_click()">AudioOff</button>
  <br>
  <video id="localVideo"></video>
  <video id="remoteVideo"></video>
  <div id='logs'>&nbsp;</div>
  <div id='connection'>&nbsp;</div>
  <div id='debug'><br>Console:<br></div>
 
  <script type="text/javascript">
    var begin = 'begin 20';
    
    var socket = io.connect();
    var streamConstraints = { "audio": false, "video": true };
    var localStream = null;
    var pc = null;
   //var servers = null;	  
var servers = {"iceServers": 
	    [
            {"url": "stun:stun.l.google.com:19302"}
	    ]
        };
	  
    console.log(begin);
    document.getElementById('debug').innerHTML += begin + '<br>'; 
  
navigator.getUserMedia = (
	navigator.getUserMedia ||
	navigator.webkitGetUserMedia ||
	navigator.mozGetUserMedia ||
	navigator.msGetUserMedia
);
	  
var RTCPeerConnection = (
	RTCPeerConnection ||
	webkitRTCPeerConnection ||
	mozRTCPeerConnection ||
	msRTCPeerConnection
);
	  
var RTCSessionDescription = (
	RTCSessionDescription ||
	webkitRTCSessionDescription ||
	mozRTCSessionDescription ||
	msRTCSessionDescription
);

var RTCIceCandidate = (
	RTCIceCandidate ||
	webkitRTCIceCandidate ||
	mozRTCIceCandidate ||
	msRTCIceCandidate
);
	  
	  if(!RTCPeerConnection) {document.getElementById('debug').innerHTML += 'Your browser does not support WebRTC<br>';}
	  else {document.getElementById('debug').innerHTML += 'Your browser supports WebRTC<br>';}

  function getUserMedia_click() {
  console.log("getUserMedia_click()");
  document.getElementById('logs').innerHTML = 'getUserMedia is clicked';
  document.getElementById('debug').innerHTML += 'getUserMedia is clicked<br>';
  
  navigator.getUserMedia(streamConstraints, getUserMedia_success, getUserMedia_error);
}
    
function getUserMedia_success(stream) {
  document.getElementById('debug').innerHTML += 'getUserMedia_success<br>';
  localVideo.src = URL.createObjectURL(stream); 
//  localVideo.srcObject = stream;
  localVideo.autoplay = true;
  localVideo.muted = true;
  localStream = stream; 
	newPeerConnection_click();
}

function getUserMedia_error(error) {
  console.log("getUserMedia_error():", error);
document.getElementById('debug').innerHTML += error;
}
///////////////////
	  
function newPeerConnection_click(){
	document.getElementById('logs').innerHTML = "newPeerConnection is clicked";
	document.getElementById('debug').innerHTML += "newPeerConnection is clicked<br>";
	
pc = new RTCPeerConnection(servers);
if (pc) {
	console.log('pc is created');
	document.getElementById('debug').innerHTML += "pc is created<br>";
	console.log(pc);
	
		pc.addStream(localStream);
		//localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
			
		console.log("MediaStream is added");
		document.getElementById('debug').innerHTML += "MediaStream is added<br>";		
	
		pc.onicecandidate = function (e){
			console.log("ICE candidate:");
			console.log(e.candidate);
			if (e.candidate) {document.getElementById('debug').innerHTML += "ICE candidate: " + e.candidate.candidate + '<br>';}
				else {document.getElementById('debug').innerHTML += "ICE candidate: null<br>";}
			socket.emit("message", {type: "candidate", candidate: e.candidate});
			};
	
		pc.onaddstream = function(e) {
			console.log("Stream received!");
			console.log(e.stream);
			document.getElementById('debug').innerHTML += "Stream received!<br>";
			document.getElementById('remoteVideo').autoplay = true;
			document.getElementById('remoteVideo').muted = true;
			document.getElementById('remoteVideo').srcObject = e.stream; 
			};	
		pc.oniceconnectionstatechange = function (e)
		{
			console.log('oniceconnectionstatechange');
			document.getElementById('debug').innerHTML += "oniceconnectionstatechange<br>";
			document.getElementById('debug').innerHTML += e.target.iceConnectionState + "<br>";
			console.log(e.target);
			document.getElementById('connection').innerHTML = e.target.iceConnectionState + " ... " + e.target.iceGatheringState;
		};	
	} else document.getElementById('debug').innerHTML += "pc is not created<br>";
	
}    
///////////////////
function createOffer_click(){	
	document.getElementById('logs').innerHTML = "createOffer is clicked";
	document.getElementById('debug').innerHTML += "createOffer is clicked<br>";
if (pc)	{
		document.getElementById('debug').innerHTML += "Offer is sending<br>";
		pc.createOffer(
			function(desc)
			{
				console.log('createOffer');
				document.getElementById('debug').innerHTML += "createOffer<br>";
				pc.setLocalDescription(desc);
				console.log('setLocalDescription');
				console.log(desc);
				document.getElementById('debug').innerHTML += "setLocalDescription<br>";
				//document.getElementById('debug').innerHTML += desc.type + "<br>";
				//socket.emit("message", desc);
				socket.emit("message", {type: 'offer'; sdp: desc});
			},
			function(err)
			{
				console.error(err);
				document.getElementById('debug').innerHTML += err + "<br>";
			}
		);
	
		} else {
			console.log('Error: pc is not created');
			document.getElementById('debug').innerHTML="Error: pc is not created";
		}


}	  
///////////////////	  
socket.on('success', function ()
{
	console.log("socket.on connected");
	document.getElementById('debug').innerHTML += "socket.on connected<br>";
});


socket.on('message', function(message)
{
	console.log("Message from server:");
	console.log(message);
	if (message.type == "answer")
	{
		if (pc){
			pc.setRemoteDescription(new RTCSessionDescription(message));
			console.log('setRemoteDescription');
			console.log(message);
			
			document.getElementById('logs').innerHTML="Aswer is received";
			document.getElementById('debug').innerHTML += "Aswer is received<br>";
			document.getElementById('debug').innerHTML += "setRemoteDescription<br>";
			//document.getElementById('debug').innerHTML += message + "<br>";

			}
	}
	
	if (message.type == "offer")
	{
			console.log('Offer is received:');
			document.getElementById('logs').innerHTML="Offer is received";
			document.getElementById('debug').innerHTML += "Offer is received<br>";

			console.log(message);
			if(pc){
				pc.setRemoteDescription(new RTCSessionDescription(message));
				console.log('setRemoteDescription');
				console.log(message);
				document.getElementById('debug').innerHTML += "setRemoteDescription<br>";

				console.log('createAnswer');
				document.getElementById('debug').innerHTML += "createAnswer<br>";

				pc.createAnswer(function(desc){
					document.getElementById('debug').innerHTML += "HERE<br>";
					pc.setLocalDescription(desc)
					console.log('setLocalDescription');
					console.log(desc);
					document.getElementById('debug').innerHTML += "setLocalDescription<br>";
					socket.emit("message", desc);
					document.getElementById('logs').innerHTML="Answer is sended";

				}, 
				function(err)
				{
					console.error(err);
					document.getElementById('debug').innerHTML += err+ "<br>";
				}
			);
			}
	}

	if (message.type == "candidate")
	{
			if (message.candidate)
			{
				console.log('IceCandidate is receved:');
				console.log(message.candidate);
				document.getElementById('debug').innerHTML += "IceCandidate is receved<br>";
				if (pc) {
					pc.addIceCandidate(new RTCIceCandidate(message.candidate));
					console.log('new IceCandidate is added');
					document.getElementById('debug').innerHTML += "new IceCandidate is added<br>";
					}
			}
	}
	
});


socket.on('error', function(err)
{
	console.log("Error!");
	console.error(err);
	document.getElementById('debug').innerHTML += "Error!<br>" + err + '<br>';

});



  </script>


  
</body>
</html>
